# .github/workflows/ci.yml
name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

# Note: Full tests with coverage run in publish.yml before PyPI release
# This workflow runs quick tests for regular development

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-python@v6
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install ruff
        run: pip install ruff

      - name: Run ruff
        run: ruff check .

  type-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-python@v6
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          python -m pip install numpy -r requirements-test.txt
          python -m pip install -e . --no-deps
          python -m pip install mypy types-PyYAML

      - name: Run mypy
        run: mypy nirs4all

  tests:
    needs: [lint, type-check]
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30
    # Allow macOS failures while platform support stabilizes
    continue-on-error: ${{ matrix.os == 'macos-latest' }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ['3.11', '3.12', '3.13']
    steps:
      - uses: actions/checkout@v6

      - name: Free disk space
        uses: ./.github/actions/free-disk-space

      - uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Stub uvloop on Windows (Unix-only package)
        if: runner.os == 'Windows'
        shell: python
        run: |
          import os, sys, tempfile, subprocess
          d = tempfile.mkdtemp(prefix="uvloop-stub-")
          os.makedirs(os.path.join(d, "uvloop"))
          with open(os.path.join(d, "uvloop", "__init__.py"), "w") as f:
              f.write('raise ImportError("uvloop does not support Windows")\n')
          with open(os.path.join(d, "pyproject.toml"), "w") as f:
              f.write('[build-system]\nrequires = ["setuptools"]\nbuild-backend = "setuptools.build_meta"\n\n[project]\nname = "uvloop"\nversion = "0.22.1"\n')
          subprocess.check_call([sys.executable, "-m", "pip", "install", d])

      - name: Install test deps
        run: |
          python -m pip install --upgrade pip setuptools wheel
          python -m pip install numpy -r requirements-test.txt

      - name: Install package (editable, no-deps â€” deps already from requirements-test.txt)
        run: python -m pip install -e . --no-deps

      - name: Run unit tests
        shell: bash
        run: |
          python -m pytest -v -n auto --dist worksteal tests/unit/

      - name: Run quick integration pytest
        shell: bash
        run: |
          # Serial subset with known write-contention under heavy xdist load
          python -m pytest -v \
            tests/integration/pipeline/test_merge_mixed.py \
            tests/integration/pipeline/test_merge_per_branch.py

          # Parallel remainder
          python -m pytest -v -n auto --dist worksteal tests/integration/pipeline/ \
            --ignore=tests/integration/pipeline/test_merge_mixed.py \
            --ignore=tests/integration/pipeline/test_merge_per_branch.py
