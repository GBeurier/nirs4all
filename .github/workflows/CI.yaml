# .github/workflows/ci.yml
name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

# Note: Full tests with coverage run in publish.yml before PyPI release
# This workflow runs quick tests for regular development

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-python@v6
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install ruff
        run: pip install ruff

      - name: Run ruff
        run: ruff check .

  type-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-python@v6
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          python -m pip install numpy -r requirements-test.txt
          python -m pip install -e . --no-deps
          python -m pip install mypy types-PyYAML

      - name: Run mypy
        run: mypy nirs4all

  tests:
    needs: [lint, type-check]
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-15]
        python-version: ['3.11', '3.12', '3.13']
    steps:
      - uses: actions/checkout@v6

      - name: Free disk space
        uses: ./.github/actions/free-disk-space

      - uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Install test deps
        shell: bash
        run: |
          python -m pip install --upgrade pip setuptools wheel
          if [ "$RUNNER_OS" == "macOS" ]; then
            # Skip all DL backends on macOS (platform compatibility check only)
            grep -v -E '^(jax|jaxlib|flax|tensorflow|torch|tabpfn|keras)' requirements-test.txt > requirements-test-filtered.txt
            python -m pip install numpy -r requirements-test-filtered.txt
          elif [ "$RUNNER_OS" == "Windows" ]; then
            # Skip JAX ecosystem on Windows (uvloop is Unix-only)
            grep -v -E '^(jax|jaxlib|flax)' requirements-test.txt > requirements-test-filtered.txt
            python -m pip install numpy -r requirements-test-filtered.txt
          else
            python -m pip install numpy -r requirements-test.txt
          fi

      - name: Install package (editable, no-deps â€” deps already from requirements-test.txt)
        run: python -m pip install -e . --no-deps

      - name: Run unit tests
        shell: bash
        env:
          OBJC_DISABLE_INITIALIZE_FORK_SAFETY: 'YES'
        run: |
          MARK=()
          if [ "$RUNNER_OS" == "macOS" ]; then
            MARK=(-m "not tensorflow and not torch and not keras and not jax and not stress")
          fi

          if [ "$RUNNER_OS" == "macOS" ]; then
            # macOS: run serially to avoid fork() deadlocks
            python -m pytest -v --timeout=120 "${MARK[@]}" tests/unit/
          else
            python -m pytest -v -n auto --dist worksteal --timeout=300 tests/unit/
          fi

      - name: Run quick integration pytest
        shell: bash
        env:
          OBJC_DISABLE_INITIALIZE_FORK_SAFETY: 'YES'
        run: |
          MARK=()
          if [ "$RUNNER_OS" == "macOS" ]; then
            MARK=(-m "not tensorflow and not torch and not keras and not jax and not stress")
          fi

          if [ "$RUNNER_OS" == "macOS" ]; then
            # macOS: run serially to avoid fork() deadlocks
            python -m pytest -v --timeout=120 "${MARK[@]}" tests/integration/pipeline/
          else
            # Serial subset with known write-contention under heavy xdist load
            python -m pytest -v --timeout=300 \
              tests/integration/pipeline/test_merge_mixed.py \
              tests/integration/pipeline/test_merge_per_branch.py

            # Parallel remainder
            python -m pytest -v -n auto --dist worksteal --timeout=300 tests/integration/pipeline/ \
              --ignore=tests/integration/pipeline/test_merge_mixed.py \
              --ignore=tests/integration/pipeline/test_merge_per_branch.py
          fi
