# .github/workflows/pre-publish.yml
# Pre-publish validation workflow
# Run this BEFORE creating a release to validate everything will pass

name: Pre-Publish Check

on:
  workflow_dispatch:  # Manual trigger only
    inputs:
      skip_tests:
        description: 'Skip test suite (faster, docs only)'
        required: false
        default: 'false'
        type: boolean

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Full test suite (same as publish.yml)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  run-tests:
    if: ${{ inputs.skip_tests == false }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: true
      matrix:
        os: [ubuntu-latest, windows-latest]
        python-version: ['3.11', '3.13']
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Install test deps
        run: |
          python -m pip install --upgrade pip setuptools wheel
          python -m pip install numpy -r requirements-test.txt

      - name: Install package (editable)
        run: python -m pip install -e .

      - name: Run full pytest + coverage
        run: |
          python -m pytest -v tests/ --cov=nirs4all --cov-report=xml

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Documentation build (same as publish.yml)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build-docs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install documentation dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          python -m pip install -r docs/readthedocs.requirements.txt

      - name: Install nirs4all package
        run: python -m pip install -e .

      - name: Build documentation (strict mode)
        run: |
          cd docs
          sphinx-build -b html source _build/html --keep-going

      - name: Upload documentation artifacts
        uses: actions/upload-artifact@v4
        with:
          name: pre-publish-docs
          path: docs/_build/html/
          retention-days: 3

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Test package build (validates setup.py/pyproject.toml)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  test-build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Build dists
        run: |
          python -m pip install --upgrade build twine
          python -m build --sdist --wheel --outdir dist

      - name: Validate package with twine
        run: python -m twine check dist/*

      - name: Test install from wheel
        run: |
          python -m pip install dist/*.whl
          python -c "import nirs4all; print(f'âœ“ nirs4all {nirs4all.__version__} installed successfully')"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Summary (runs after all jobs, reports status)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  summary:
    needs: [run-tests, build-docs, test-build]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Check results
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘              PRE-PUBLISH VALIDATION SUMMARY                   â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"

          # Check each job result
          tests_result="${{ needs.run-tests.result }}"
          docs_result="${{ needs.build-docs.result }}"
          build_result="${{ needs.test-build.result }}"

          # Handle skipped tests
          if [ "$tests_result" == "skipped" ]; then
            echo "â•‘  Tests:         â­ï¸  SKIPPED (user requested)                 â•‘"
          elif [ "$tests_result" == "success" ]; then
            echo "â•‘  Tests:         âœ… PASSED                                    â•‘"
          else
            echo "â•‘  Tests:         âŒ FAILED                                    â•‘"
          fi

          if [ "$docs_result" == "success" ]; then
            echo "â•‘  Documentation: âœ… PASSED                                    â•‘"
          else
            echo "â•‘  Documentation: âŒ FAILED                                    â•‘"
          fi

          if [ "$build_result" == "success" ]; then
            echo "â•‘  Package Build: âœ… PASSED                                    â•‘"
          else
            echo "â•‘  Package Build: âŒ FAILED                                    â•‘"
          fi

          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"

          # Determine overall status
          if [ "$docs_result" == "success" ] && [ "$build_result" == "success" ]; then
            if [ "$tests_result" == "success" ] || [ "$tests_result" == "skipped" ]; then
              echo "â•‘  ğŸ‰ Ready to publish! Create your release now.              â•‘"
              echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              exit 0
            fi
          fi

          echo "â•‘  âš ï¸  Fix issues above before creating a release.              â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          exit 1
