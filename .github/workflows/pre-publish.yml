# .github/workflows/pre-publish.yml
# Pre-publish validation workflow
# Run this BEFORE creating a release to validate everything will pass

name: Pre-Publish Check

on:
  workflow_dispatch:  # Manual trigger only
    inputs:
      skip_tests:
        description: 'Skip test suite (faster, docs only)'
        required: false
        default: 'false'
        type: boolean

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Ruff linting
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  ruff:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-python@v6
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install ruff
        run: python -m pip install --upgrade ruff

      - name: Run ruff check
        run: ruff check .

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Mypy type checking
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  mypy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-python@v6
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          python -m pip install numpy -r requirements-test.txt
          python -m pip install -e .
          python -m pip install mypy types-PyYAML

      - name: Run mypy
        run: mypy .

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Full test suite (same as publish.yml)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  run-tests:
    if: ${{ inputs.skip_tests == false }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: true
      matrix:
        os: [ubuntu-latest, windows-latest]
        python-version: ['3.11', '3.13']
    steps:
      - uses: actions/checkout@v6

      - name: Free disk space
        uses: ./.github/actions/free-disk-space

      - uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Install test deps
        run: |
          python -m pip install --upgrade pip setuptools wheel
          python -m pip install numpy -r requirements-test.txt

      - name: Install package (editable)
        run: python -m pip install -e .

      - name: Run full pytest + coverage
        shell: bash
        run: |
          # Serial subset with known write-contention under heavy xdist load
          python -m pytest -v \
            tests/integration/pipeline/test_merge_mixed.py \
            tests/integration/pipeline/test_merge_per_branch.py \
            --cov=nirs4all --cov-append

          # Parallel remainder
          python -m pytest -v -n auto --dist worksteal tests/ \
            --ignore=tests/integration/pipeline/test_merge_mixed.py \
            --ignore=tests/integration/pipeline/test_merge_per_branch.py \
            --cov=nirs4all --cov-append --cov-report=xml

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Documentation build (same as publish.yml)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build-docs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Free disk space
        uses: ./.github/actions/free-disk-space

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install documentation dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          python -m pip install -r docs/readthedocs.requirements.txt

      - name: Install nirs4all package
        run: python -m pip install -e .

      - name: Build documentation (strict mode)
        run: |
          cd docs
          sphinx-build -b html source _build/html --keep-going

      - name: Upload documentation artifacts
        uses: actions/upload-artifact@v6
        with:
          name: pre-publish-docs
          path: docs/_build/html/
          retention-days: 3

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Verify examples (parallelized by category)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  verify-examples:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        category: [user, developer, reference]
    steps:
      - uses: actions/checkout@v6

      - name: Free disk space
        uses: ./.github/actions/free-disk-space

      - uses: actions/setup-python@v6
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          python -m pip install numpy
          python -m pip install torch --index-url https://download.pytorch.org/whl/cpu
          python -m pip install jax jaxlib
          python -m pip install tensorflow
          python -m pip install -r requirements-examples.txt
          python -m pip install -e .

      - name: Run ${{ matrix.category }} examples
        run: |
          cd examples
          chmod +x run.sh
          ./run.sh -c ${{ matrix.category }}
        timeout-minutes: 30

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Test package build (validates setup.py/pyproject.toml)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  test-build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Free disk space
        uses: ./.github/actions/free-disk-space

      - uses: actions/setup-python@v6
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Build dists
        run: |
          python -m pip install --upgrade build twine
          python -m build --sdist --wheel --outdir dist

      - name: Validate package with twine
        run: python -m twine check dist/*

      - name: Test install from wheel
        run: |
          python -m pip install dist/*.whl
          python -c "import nirs4all; print(f'nirs4all {nirs4all.__version__} installed successfully')"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Summary (runs after all jobs, reports status)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  summary:
    needs: [ruff, mypy, run-tests, build-docs, test-build, verify-examples]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Check results
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘              PRE-PUBLISH VALIDATION SUMMARY                  â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"

          ruff_result="${{ needs.ruff.result }}"
          mypy_result="${{ needs.mypy.result }}"
          tests_result="${{ needs.run-tests.result }}"
          docs_result="${{ needs.build-docs.result }}"
          build_result="${{ needs.test-build.result }}"
          examples_result="${{ needs.verify-examples.result }}"

          # --- Ruff ---
          if [ "$ruff_result" == "success" ]; then
            echo "â•‘  Ruff:          âœ… PASSED                                   â•‘"
          else
            echo "â•‘  Ruff:          âŒ FAILED                                   â•‘"
          fi

          # --- Mypy ---
          if [ "$mypy_result" == "success" ]; then
            echo "â•‘  Mypy:          âœ… PASSED                                   â•‘"
          else
            echo "â•‘  Mypy:          âŒ FAILED                                   â•‘"
          fi

          # --- Tests ---
          if [ "$tests_result" == "skipped" ]; then
            echo "â•‘  Tests:         â­ï¸  SKIPPED (user requested)                â•‘"
          elif [ "$tests_result" == "success" ]; then
            echo "â•‘  Tests:         âœ… PASSED                                   â•‘"
          else
            echo "â•‘  Tests:         âŒ FAILED                                   â•‘"
          fi

          # --- Docs ---
          if [ "$docs_result" == "success" ]; then
            echo "â•‘  Documentation: âœ… PASSED                                   â•‘"
          else
            echo "â•‘  Documentation: âŒ FAILED                                   â•‘"
          fi

          # --- Build ---
          if [ "$build_result" == "success" ]; then
            echo "â•‘  Package Build: âœ… PASSED                                   â•‘"
          else
            echo "â•‘  Package Build: âŒ FAILED                                   â•‘"
          fi

          # --- Examples ---
          if [ "$examples_result" == "success" ]; then
            echo "â•‘  Examples:      âœ… PASSED                                   â•‘"
          else
            echo "â•‘  Examples:      âŒ FAILED                                   â•‘"
          fi

          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"

          # Determine overall status
          all_pass=true
          for result in "$ruff_result" "$mypy_result" "$docs_result" "$build_result" "$examples_result"; do
            if [ "$result" != "success" ]; then
              all_pass=false
            fi
          done

          # Tests can be skipped
          if [ "$tests_result" != "success" ] && [ "$tests_result" != "skipped" ]; then
            all_pass=false
          fi

          if [ "$all_pass" == "true" ]; then
            echo "â•‘  ğŸ‰ Ready to publish! Create your release now.             â•‘"
            echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            exit 0
          fi

          echo "â•‘  âš ï¸  Fix issues above before creating a release.             â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          exit 1
