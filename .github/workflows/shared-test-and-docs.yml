# .github/workflows/shared-test-and-docs.yml
# Reusable workflow: full test matrix + documentation build.
# Called by pre-publish.yml and publish.yml via workflow_call.
name: Shared – Test and Docs

on:
  workflow_call:
    inputs:
      fail-fast:
        description: 'Stop matrix on first failure'
        type: boolean
        default: true
      skip-tests:
        description: 'Skip the test matrix (docs only)'
        type: boolean
        default: false
      upload-coverage:
        description: 'Upload coverage report to Codecov'
        type: boolean
        default: false
      docs-artifact-name:
        description: 'Name for the documentation artifact'
        type: string
        default: 'documentation-html'
      docs-retention-days:
        description: 'Days to retain the documentation artifact'
        type: number
        default: 7

jobs:
  run-tests:
    if: ${{ !inputs.skip-tests }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: ${{ inputs.fail-fast }}
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ['3.11', '3.13']
        exclude:
          # macOS only needs one Python version for platform compatibility
          - os: macos-latest
            python-version: '3.11'
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v6

      - name: Free disk space
        uses: ./.github/actions/free-disk-space

      - uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Install test deps
        shell: bash
        run: |
          python -m pip install --upgrade pip setuptools wheel
          if [ "$RUNNER_OS" == "macOS" ]; then
            # Skip all DL backends on macOS (platform compatibility check only)
            grep -v -E '^(jax|jaxlib|flax|tensorflow|torch|tabpfn|keras)' requirements-test.txt > requirements-test-macos.txt
            python -m pip install numpy -r requirements-test-macos.txt
          elif [ "$RUNNER_OS" == "Windows" ]; then
            # Skip JAX ecosystem on Windows (orbax-checkpoint pulls uvloop which is Unix-only)
            grep -v -E '^(jax|jaxlib|flax)' requirements-test.txt > requirements-test-win.txt
            python -m pip install numpy -r requirements-test-win.txt
          else
            python -m pip install numpy -r requirements-test.txt
          fi

      - name: Install package (editable, no-deps — deps already from requirements-test.txt)
        run: python -m pip install -e . --no-deps

      - name: Run full pytest + coverage
        shell: bash
        run: |
          MARK=()
          if [ "$RUNNER_OS" == "macOS" ]; then
            MARK=(-m "not tensorflow and not torch and not keras and not jax and not stress")
          fi

          if [ "$RUNNER_OS" == "macOS" ]; then
            # macOS: run serially (fork() is unsafe on macOS, xdist workers deadlock)
            python -m pytest -v --timeout=120 \
              "${MARK[@]}" \
              --cov=nirs4all --cov-append --cov-report=xml \
              tests/
          else
            # Serial subset with known write-contention under heavy xdist load
            python -m pytest -v \
              tests/integration/pipeline/test_merge_mixed.py \
              tests/integration/pipeline/test_merge_per_branch.py \
              --cov=nirs4all --cov-append

            # Parallel remainder
            python -m pytest -v -n auto --dist worksteal tests/ \
              --ignore=tests/integration/pipeline/test_merge_mixed.py \
              --ignore=tests/integration/pipeline/test_merge_per_branch.py \
              --cov=nirs4all --cov-append --cov-report=xml
          fi

      - name: Upload coverage to Codecov
        if: ${{ inputs.upload-coverage }}
        uses: codecov/codecov-action@v5
        with:
          file: ./coverage.xml
          fail_ci_if_error: false

  build-docs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Free disk space
        uses: ./.github/actions/free-disk-space

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install documentation dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          python -m pip install -r docs/readthedocs.requirements.txt

      - name: Install nirs4all package
        run: python -m pip install -e .

      - name: Build documentation
        run: |
          cd docs
          sphinx-build -b html source _build/html --keep-going

      - name: Upload documentation artifacts
        uses: actions/upload-artifact@v7
        with:
          name: ${{ inputs.docs-artifact-name }}
          path: docs/_build/html/
          retention-days: ${{ inputs.docs-retention-days }}
