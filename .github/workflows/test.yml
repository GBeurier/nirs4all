name: Run Tests with All ML Backends

on:
  push:
    branches: [ main, master ]
    tags:
      - '*'
  pull_request:
    branches: [ main, master ]

jobs:
  test-default:
    if: github.event_name != 'push' || !startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.10]
    steps:
    - uses: actions/checkout@v4
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'
    - name: Install dependencies explicitly
      run: |
        python -m pip install --upgrade pip setuptools wheel
        python -m pip install numpy
        python -m pip install -r requirements-test.txt
    - name: List installed packages
      run: |
        pip freeze
    - name: Install package
      run: |
        python -m pip install -e .
    - name: Debug Python path
      run: |
        python -c "import sys; print('Python path:', sys.path)"
        python -c "import sys; print('Workspace directory listed in path?', '/home/runner/work/nirs4all/nirs4all' in sys.path)"
    - name: Verify imports
      run: |
        python -c "import numpy; import pandas; import scipy; import sklearn; import pywt; print('Critical imports successful')"
        python -c "import pytest; print('Pytest import successful')"
        python -c "import nirs4all; print('Nirs4all import successful')"
    - name: Test with pytest
      run: |
        python -m pytest -v tests/

  test-full-matrix:
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ['3.9', '3.10', '3.11', '3.12']
    steps:
    - uses: actions/checkout@v4
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'
    - name: Install dependencies explicitly
      run: |
        python -m pip install --upgrade pip setuptools wheel
        python -m pip install numpy
        python -m pip install -r requirements-test.txt
    - name: List installed packages
      run: |
        pip freeze
    - name: Install package
      run: |
        python -m pip install -e .
    - name: Debug Python path
      run: |
        python -c "import sys; print('Python path:', sys.path)"
        python -c "import sys; print('Workspace directory listed in path?', '/home/runner/work/nirs4all/nirs4all' in sys.path)"
    - name: Verify imports
      run: |
        python -c "import numpy; import pandas; import scipy; import sklearn; import pywt; print('Critical imports successful')"
        python -c "import pytest; print('Pytest import successful')"
        python -c "import nirs4all; print('Nirs4all import successful')"
    - name: Test with pytest
      run: |
        python -m pytest -v tests/
    - name: Run coverage tests
      run: |
        python -m pytest -v tests/ --cov=nirs4all --cov-report=xml
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        fail_ci_if_error: false